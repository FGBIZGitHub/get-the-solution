# Working with adb

Working with the command-line tool `adb` can get very handy, when you are trying to analyze an installed android app on your device. To get started you need install the Android SDK which shipps the tool `adb` (beside some other helpfull applications).
I find it quite pleasant to add the directory, which is containing the executable `adb`, to the `$PATH` enviroment. So `adb` will always be available in command-line (without switching into the android skd binary folder).  

The next step is to "activate" the adb endpoint on your (mobile) device. This can be achieved by enabling `USB debugging` under `Developer options`. Maybe as a side note, this works propably on most consumer mobile devices. If you own a work phone, its possible that the company applied restrictive policy rules and enabling 'USB debugging' is not enough to get the adb server working.

If you are activating `USB debugging` and connecting the device to your computer the first time you should see something like this:

[image]

In this case the device should be listed with the command `adb devices`

```bash
adb devices
List of devices attached
AEUBB17928505230        device
```

Android is running some kind of linux derivation, and `adb` makes it accessable by the command `adb shell`. This way we are able to execute some known linux commands like `ls`, `ps` and so on. You can do that by `adb shell YOURCOMMAND` or `adb shell` which opens the bash. Lets do so.

```bash
adb shell
1|HWSLA-Q:/ $ ls
ls: ./verity_key: Permission denied
ls:[...]
acct       charger cust_comm data  dsp      hw_oem oem     product           root   storage tombstones
bugreports config  cust_spec dev   etc      log    persist property_contexts sbin   sys     vendor
cache      cust    d         dload firmware mnt    proc    res               sdcard system  version
1|HWSLA-Q:/ $
```
You see the typical Filesystem Hierarchy Standard of linux. But lets move on and display all installed app packages on the device. We can use the command `pm` (or `adb shell cmd package list packages` but then you have to exit bash) with parameter `-f` (to display the installed path) and use `grep` to filter for a specific app name. For example:

```bash
HWSLA-Q:/ $ pm list packages -f | grep microsoft
package:/data/app/com.microsoft.appmanager-1/base.apk=com.microsoft.appmanager
package:/data/app/com.microsoft.office.officelens-2/base.apk=com.microsoft.office.officelens
package:/data/app/com.microsoft.skydrive-1/base.apk=com.microsoft.skydrive
package:/data/app/com.microsoft.office.onenote-2/base.apk=com.microsoft.office.onenote
package:/data/app/com.microsoft.emmx-2/base.apk=com.microsoft.emmx
package:/data/app/com.microsoft.office.outlook-1/base.apk=com.microsoft.office.outlook
package:/data/app/com.microsoft.office.word-2/base.apk=com.microsoft.office.word
HWSLA-Q:/ $ pm list packages | grep qr
package:com.kitkats.qrscanner
```

To create a backup of an android app you can use `adb backup`. For this you need to leave the linux device bash with `exit`
In the sample I created a backup of the app package `at.oebb.ts` and store the backup into the file `oebb.backu`. When calling the command you need to unlock your device and press "Backup my Data" (the password filed can be empty).

```bash
C:\Users>adb backup -apk -shared packages at.oebb.ts -f oebb.backu
Now unlock your device and confirm the backup operation...  
```
Now lets extract the backup so we are able to see the content of it. For this I used ` ( printf "\x1f\x8b\x08\x00\x00\x00\x00\x00" ; tail -c +25 oebb.backu ) |  tar xfvz -` 

From the extracted files you can determine that the app "Ã¶bb" is using for storing data a sqlite database (Application.db) and for logging and app usage analysis the service of Microsoft named Appcenter.ms (AppCenter.xml). 

There is also an other way to retriev the data from the device to your computer. Lets use `adb pull` for it. First we copy our file to the `/sdcard/` (adb pull has only access to the sdcard) by using `adb shell "cp /data/app/at.oebb.ts-2/base.apk /sdcard/base.apk"`. Now we can pull it from our device as shown below.

```bash
adb pull /sdcard/base.apk base.apk.oebb
/sdcard/base.apk: 1 file pulled. 21.8 MB/s (23672488 bytes in 1.034s)
```

Having the base.apk allows us to view the `AndroidManifest.xml` with `aapt2 d xmltree --file AndroidManifest.xml base.apk.oebb` (The program `aapt2` is also shipped with the Android SDK.). This shows the version, the permission and some other details the app is using.

```bash
C:\Users>aapt2 d xmltree --file AndroidManifest.xml base.apk.oebb
N: android=http://schemas.android.com/apk/res/android (line=2)
  E: manifest (line=2)
    A: http://schemas.android.com/apk/res/android:versionCode(0x0101021b)=19295
    A: http://schemas.android.com/apk/res/android:versionName(0x0101021c)="4.252.0.469.19295" (Raw: "4.252.0.469.19295")
    A: http://schemas.android.com/apk/res/android:installLocation(0x010102b7)=0
    A: http://schemas.android.com/apk/res/android:compileSdkVersion(0x01010572)=29
    A: http://schemas.android.com/apk/res/android:compileSdkVersionCodename(0x01010573)="10" (Raw: "10")
    A: package="at.oebb.ts" (Raw: "at.oebb.ts")
    A: platformBuildVersionCode=29
    A: platformBuildVersionName=10
      E: uses-sdk (line=8)
        A: http://schemas.android.com/apk/res/android:minSdkVersion(0x0101020c)=21
        A: http://schemas.android.com/apk/res/android:targetSdkVersion(0x01010270)=29
      E: uses-permission (line=12)
        A: http://schemas.android.com/apk/res/android:name(0x01010003)="android.permission.
[...]
```

If your device is rooted, you will be able to modify the downloaded app data and push them back to the device. An alternative would be to use `adb shell run-as app.package yourcommand` but this only works if a debugable version of the app is installed (which is mainly only the case if you are the developer of the app).

To push the file from your computer to the (mobile) device use for example `adb push localfilesystem /sdcard/filename`. After the file is pushed to the sdcard of the device make use of `adb shell` in combination with `cp` or `mv` to move it further to the app location. If there is already a file existing on the device with the same name in your target location, I would recommend it to rename it as `cp -f` didn't worked out for me. 


